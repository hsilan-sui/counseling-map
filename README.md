# Counseling Mapï½œ114å¹´å…¨å°å¿ƒç†å¥åº·æ”¯æŒæ–¹æ¡ˆå¿ƒç†è«®å•†åœ°åœ–

> ç‚ºä»€éº¼è¦å¯«é€™å€‹ç¶²ç«™ï¼Ÿ
- è¡›ç¦éƒ¨åœ¨ 2023 å¹´æ¨å‡ºã€Œ15â€“45 æ­²å¿ƒç†å¥åº·æ”¯æŒæ–¹æ¡ˆï¼Œè£œåŠ©æ¯äººæœ€å¤š 3 æ¬¡å…è²»å¿ƒç†è«®å•†ã€‚
- æƒŸè¡›ç¦éƒ¨æŸ¥è©¢ç¶²ç«™[è¡›ç”Ÿç¦åˆ©éƒ¨-15-45æ­²é’å£¯ä¸–ä»£å¿ƒç†å¥åº·æ”¯æŒæ–¹æ¡ˆ](https://sps.mohw.gov.tw/mhs)ï¼Œä½†ä½¿ç”¨ä¸Šä¸å¤ ç›´è¦ºï¼Œå°æœ‰éœ€è¦çš„æ°‘çœ¾ä¾†èªªï¼Œé›£ä»¥å¿«é€Ÿæ‰¾åˆ°é™„è¿‘æœ‰åé¡çš„åˆä½œæ©Ÿæ§‹ã€‚ä¹Ÿåˆæ­¥ä¸å¤ªæ¸…æ¥šå¦‚ä½•ä½¿ç”¨é€™å€‹æ–¹æ¡ˆèˆ‡æµç¨‹ã€‚
- æ‰€ä»¥åšäº†é€™å€‹ç¶²ç«™ï¼Œå¸Œæœ›å”åŠ©éœ€è¦å¿ƒç†æ”¯æŒçš„æœ‹å‹å€‘ï¼Œæ›´æ–¹ä¾¿åœ°æŸ¥è©¢å¯é ç´„çš„è¨ºæ‰€èˆ‡æ–¹æ¡ˆè³‡æºã€‚
- é€™æ˜¯ä¸€å€‹éå•†æ¥­çš„å…¬ç›Š side projectè³‡æ–™ä¾†è‡ªæ”¿åºœå„ç¸£å¸‚è¡›ç”Ÿå±€èˆ‡å®˜æ–¹å…¬å‘Šï¼Œæ¯ä¸€é€±æ–¹æ¡ˆåé¡æœƒè®Šå‹•ï¼Œä»æœƒç›¡åŠ›ä¿æŒæ›´æ–°ã€‚
- å¦‚æœä½ /å¦³ä¹Ÿè¦ºå¾—é€™å€‹æ–¹æ¡ˆå¾ˆé‡è¦ï¼Œæ­¡è¿åˆ†äº«çµ¦éœ€è¦çš„æœ‹å‹â¤ï¸æ­¤æ–¹æ¡ˆåªé©ç”¨åˆ°ä»Šå¹´å¹´åº•

> ä»¥ **Next.js + TypeScript + Tailwind CSS + Leafletï¼ˆOpenStreetMapï¼‰** æ‰“é€ çš„é–‹æºåœ°åœ–å·¥å…·ã€‚  
> æ”¯æ´ã€Œå®šä½æœ€è¿‘è¨ºæ‰€ã€ã€ã€Œåé¡ç¯©é¸ã€ã€ã€Œåç¨±/åœ°å€æœå°‹ã€ã€ã€ŒRWDï¼ˆ1170/768 æ–·é»ï¼‰ã€èˆ‡ã€Œè³‡æ–™åº§æ¨™è‡ªå‹•æ ¡æ­£ã€ã€‚

---

## åŠŸèƒ½

- ğŸ“ **å®šä½èˆ‡æ’åº**ï¼šè®€å–ç€è¦½å™¨ Geolocationï¼Œä¾è·é›¢ç”±è¿‘åˆ°é ï¼ˆé è¨­åƒ…ç´å…¥ 30 km å…§ï¼‰ã€‚
- ğŸ” **æœå°‹**ï¼šè¨ºæ‰€åç¨± / åœ°å€æœå°‹ï¼Œæ­é… `<datalist>` æç¤ºã€‚
- âœ… **åé¡ç¯©é¸**ï¼šå…¨éƒ¨ / æœ‰åé¡ / ç„¡åé¡ã€‚
- ğŸ—ºï¸ **åœ°åœ–**ï¼šLeaflet + OpenStreetMapï¼ˆ**ä¸ç”¨ Google Mapsã€ä¸ç”¨é‡‘é‘°**ï¼‰ã€‚
- ğŸ§­ **åº§æ¨™è‡ªå‹•æ ¡æ­£**ï¼šåµæ¸¬ `lat/lng` åå¯«è‡ªå‹•äº¤æ›ã€‚
- ğŸ§© **ç¸£å¸‚æ¨æ–·**ï¼šä»¥åº§æ¨™æ¯”å° 22 ç¸£å¸‚é‡å¿ƒï¼Œçµ±ä¸€ç‚º `geoCounty` ç”¨æ–¼æ’åº/é¡¯ç¤ºã€‚
- ğŸ“¢ **å…¬å‘Š**ï¼šé¦–æ¬¡é¡¯ç¤ºï¼Œä¹‹å¾Œä»¥ `localStorage` è¨˜éŒ„å·²è®€ï¼ˆ`announce:v2-2025-09-04`ï¼‰ã€‚
- ğŸ“± **RWD**ï¼šå…©æ®µé‡é»æ–·é»  
  - `< 1170px`ï¼šå·¥å…·åˆ—ç›´æ’ã€å…ƒä»¶è‡ªå‹•æ›è¡Œ  
  - `< 768px`ï¼šæ‰‹æ©Ÿ UIï¼ˆå­—ç´š/é–“è·æ›´ç·Šæ¹Šï¼‰

---

## ç·šä¸Šå±•ç¤º

- Demoï¼š`https://counseling-map-nrwv.vercel.app/` 

---

## æŠ€è¡“æ£§

- **Next.js**ï¼ˆPages Routerï¼‰
- **TypeScript**
- **Tailwind CSS**
- **Leaflet / react-leaflet**
- éœæ…‹è³‡æ–™ï¼š`public/clinic.json`

---

## å®‰è£èˆ‡å•Ÿå‹•

```bash
# 1) å®‰è£ä¾è³´
npm i

# 2) é–‹ç™¼æ¨¡å¼
npm run dev
# http://localhost:3000

# 3) æ­£å¼å»ºç½®èˆ‡å•Ÿå‹•
npm run build
npm start
```

--- 

## å°ˆæ¡ˆçµæ§‹
```
public/
  clinic.json
  full_taiwan.json
  favicon.ico
src/
  components/
    AnnouncementPanel.tsx
    LeftSidebar.tsx
    Map.tsx
    RecenterMapWithSearch.tsx
  pages/
    _app.tsx
    _document.tsx
    index.tsx
  styles/
    globals.css
  types/
    clinic.ts
.eslint.config.mjs

```

--- 

## è³‡æ–™æ ¼å¼ï¼ˆpublic/clinic.jsonï¼‰
```json
{
  "county": "è‡ºåŒ—å¸‚",
  "total": 136,
  "rows": [
    {
      "county": "è‡ºåŒ—å¸‚",
      "org_name": "ææ”¿æ´‹èº«å¿ƒè¨ºæ‰€",
      "org_url": "https://www.leepsyclinic.com/",
      "phone": "02-27620086ã€02-27473339",
      "address": "è‡ºåŒ—å¸‚æ¾å±±å€ä¸‰æ°‘è·¯84è™Ÿ.å¥åº·è·¯345è™ŸåŠæ°‘ç”Ÿæ±è·¯5æ®µ192è™Ÿ2æ¨“ä¹‹3",
      "map_url": "https://www.google.com.tw/maps/place/...",
      "pay_detail": "æ›è™Ÿè²»600å…ƒ",
      "this_week": 0,
      "next_week": 1,
      "next_2_week": 1,
      "next_3_week": 4,
      "in_4_weeks": 6,
      "edit_date": "2025/09/01",
      "teleconsultation": true,
      "has_quota": true,
      "lat": 25.0564987,
      "lng": 121.5638555
    }
  ]
}

```

- å°æ‡‰å‹åˆ¥ï¼ˆsrc/types/clinic.ts ç¯€éŒ„ï¼‰ï¼š
```tsx
export type Clinic = {
  id?: string;        // è®€å…¥æ™‚è£œ
  county: string;
  org_name: string;
  org_url?: string | null;
  phone?: string | null;
  address: string;
  map_url?: string | null;
  pay_detail?: string | null;
  this_week?: number;
  next_week?: number;
  next_2_week?: number;
  next_3_week?: number;
  in_4_weeks?: number;
  edit_date?: string;
  teleconsultation?: boolean;
  has_quota: boolean;
  lat: number;
  lng: number;
  // runtime åŠ å€¼
  distance?: number;
};

```

## å‰ç«¯æ ¸å¿ƒï¼ˆé‚è¼¯ç¯€éŒ„ï¼‰

- 1) ç¶“ç·¯åº¦æ ¡æ­£ & è·é›¢ï¼ˆHaversineï¼‰
```tsx
const isTWLat = (lat: number) => lat >= 21 && lat <= 26.5;
const isTWLng = (lng: number) => lng >= 119 && lng <= 123.5;

export function normalizeLatLng(lat: number, lng: number) {
  const ok = isTWLat(lat) && isTWLng(lng);
  const swappedOk = isTWLat(lng) && isTWLng(lat);
  if (ok) return { lat, lng };
  if (!ok && swappedOk) return { lat: lng, lng: lat };
  return { lat, lng };
}

export function haversineDistance(aLat: number, aLng: number, bLat: number, bLng: number) {
  const toRad = (x: number) => (x * Math.PI) / 180;
  const R = 6371;
  const dLat = toRad(bLat - aLat);
  const dLng = toRad(bLng - aLng);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

```

- 2) ä»¥åº§æ¨™æ¨æ–·ç¸£å¸‚ï¼ˆ22 ç¸£å¸‚é‡å¿ƒæœ€è¿‘è€…ï¼‰
```tsx
const COUNTY_CENTROIDS = [ /* åŸºéš†/åŒ—åŒ—åŸºâ€¦é‡‘é–€/é€£æ±Ÿ */ ];
export function countyByCoords(lat: number, lng: number) {
  let best = COUNTY_CENTROIDS[0].name, bestD = Infinity;
  for (const c of COUNTY_CENTROIDS) {
    const d = haversineDistance(lat, lng, c.lat, c.lng);
    if (d < bestD) { best = c.name; bestD = d; }
  }
  return best;
}
```

- 3) è·é›¢æ’åºæ± èˆ‡é™åˆ¶
```tsx
const DIST_LIMIT_KM = 30;

function sortClinicsByDistanceFrom(ulat: number, ulng: number, list: Clinic[]) {
  return [...list]
    .map(c => ({ ...c, distance: haversineDistance(ulat, ulng, c.lat, c.lng) }))
    .filter(c => c.distance! <= DIST_LIMIT_KM)
    .sort((a, b) => a.distance! - b.distance!);
}

```

- 4) RWD å·¥å…·åˆ—é¿è®“ï¼ˆé¿å… Popup è¢«é®ï¼‰
```tsx
// ä»¥ ResizeObserver é‡æ¸¬å·¥å…·åˆ—é«˜åº¦ï¼Œå‚³å…¥ Map å…ƒä»¶çš„ topSafePx
const toolbarRef = useRef<HTMLDivElement>(null);
const [topSafe, setTopSafe] = useState(140);

useEffect(() => {
  const el = toolbarRef.current;
  if (!el) return;
  const update = () => setTopSafe(el.getBoundingClientRect().height + 16);
  update();
  const ro = new ResizeObserver(update);
  ro.observe(el);
  window.addEventListener("resize", update);
  return () => { ro.disconnect(); window.removeEventListener("resize", update); };
}, []);

```

## RWD è¦æ ¼
- â‰¥ 1170pxï¼ˆæ¡Œæ©Ÿï¼‰
    - å·¦å´æ¸…å–®å›ºå®šå´æ¬„ w-80ï¼ˆ320pxï¼‰ï¼Œåœ°åœ–å®¹å™¨ md:ml-80

- < 1170pxï¼ˆå¹³æ¿ï¼‰
    - å·¥å…·åˆ— ç›´æ’ã€å¯¬åº¦æ’æ»¿ï¼›ç¯©é¸ç¾¤çµ„å…è¨±æ›è¡Œ

- < 768pxï¼ˆæ‰‹æ©Ÿï¼‰
    - æ–‡å­—/é–“è·ç¸®å°ï¼Œæ“ä½œæŒ‰éˆ•æ›´è²¼æ‰‹

## éƒ¨ç½²
```bash
npm run build
npm start

```
- æ¨è–¦ Vercelï¼šé›¶è¨­å®šå³å¯éƒ¨ç½² Next.jsã€‚
- OSM æˆæ¬Šï¼šè«‹ä¿ç•™ `<TileLayer>` çš„ attributionã€‚

## å®šæ™‚æ›´æ–°è³‡æ–™ï¼ˆGitHub Actions ç¯„æœ¬ï¼‰

## æˆæ¬Š
- ç¨‹å¼ç¢¼ï¼šMIT
- åœ°åœ–èˆ‡åœ°ç†è³‡æ–™ï¼šOpenStreetMap è²¢ç»è€…ï¼ˆé ˆä¿ç•™ attributionï¼‰

- è¨ºæ‰€è³‡æ–™ï¼špublic/clinic.json
    - æºè‡ªæ–¼æ”¿åºœè¡›ç¦éƒ¨å¿ƒç†è«®å•†åˆä½œæ©Ÿæ§‹ç¶²ç«™(`https://sps.mohw.gov.tw/mhs`)
